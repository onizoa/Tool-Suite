<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Hot Alerts - Tool Suite</title>
    <link rel="icon" type="image/png" href="https://placehold.co/32x32/55acee/ffffff?text=HA">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap');

        :root {
            --font-family-sans: 'Inter', sans-serif;
            --transition-speed: 0.3s;
            --animation-speed: 0.4s;

            /* Dark Theme */
            --background-dark: #111111;
            --surface-dark: #1c1c1c;
            --surface-light-dark: #2a2a2a;
            --on-surface-dark: #e0e0e0;
            --on-surface-variant-dark: #8c8c8c;
            --primary-dark: #00aaff;
            --primary-variant-dark: #0088cc;
            --border-dark: #333333;
            --thumb-dark: #4a4a4a;
            --shadow-dark: rgba(0, 0, 0, 0.3);
            --error-dark: #ff5252;
            --warning-dark: #2e2020;
            --warning-text-dark: #ff8f8f;
            --modal-backdrop-dark: rgba(0, 0, 0, 0.6);

            /* Light Theme */
            --background-light: #f5f7fa;
            --surface-light: #ffffff;
            --surface-light-light: #f0f2f5;
            --on-surface-light: #111111;
            --on-surface-variant-light: #6c757d;
            --primary-light: #007bff;
            --primary-variant-light: #0056b3;
            --border-light: #e0e0e0;
            --thumb-light: #c1c1c1;
            --shadow-light: rgba(0, 0, 0, 0.1);
            --error-light: #dc3545;
            --warning-light: #ffe0e0;
            --warning-text-light: #aa0000;
            --modal-backdrop-light: rgba(200, 200, 200, 0.6);

            /* Default to Dark Theme */
            --c-background: var(--background-dark);
            --c-surface: var(--surface-dark);
            --c-surface-light: var(--surface-light-dark);
            --c-on-surface: var(--on-surface-dark);
            --c-on-surface-variant: var(--on-surface-variant-dark);
            --c-primary: var(--primary-dark);
            --c-primary-variant: var(--primary-variant-dark);
            --c-border: var(--border-dark);
            --c-thumb: var(--thumb-dark);
            --c-shadow: var(--shadow-dark);
            --c-error: var(--error-dark);
            --c-warning: var(--warning-dark);
            --c-warning-text: var(--warning-text-dark);
            --c-modal-backdrop: var(--modal-backdrop-dark);
        }

        body.light-mode {
            --c-background: var(--background-light);
            --c-surface: var(--surface-light);
            --c-surface-light: var(--surface-light-light);
            --c-on-surface: var(--on-surface-light);
            --c-on-surface-variant: var(--on-surface-variant-light);
            --c-primary: var(--primary-light);
            --c-primary-variant: var(--primary-variant-light);
            --c-border: var(--border-light);
            --c-thumb: var(--thumb-light);
            --c-shadow: var(--shadow-light);
            --c-error: var(--error-light);
            --c-warning: var(--warning-light);
            --c-warning-text: var(--warning-text-light);
            --c-modal-backdrop: var(--modal-backdrop-light);
        }

        *, *::before, *::after { box-sizing: border-box; }
        
        body { margin: 0; font-family: var(--font-family-sans); background-color: var(--c-background); color: var(--c-on-surface); display: flex; height: 100vh; overflow: hidden; transition: background-color var(--transition-speed), color var(--transition-speed); cursor: default; user-select: none; -webkit-user-select: none; }
        input, textarea, .template-preview, .template-preview * { user-select: text; -webkit-user-select: text; cursor: text; }
        select, button { cursor: pointer; }

        ::-webkit-scrollbar { width: 8px; height: 8px; }
        ::-webkit-scrollbar-track { background-color: transparent; }
        ::-webkit-scrollbar-thumb { background-color: var(--c-thumb); border-radius: 4px; border: 2px solid var(--c-surface); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--c-primary-variant); }
        .sidebar-content, .card-container, .settings-container, #manageTemplatesContainer { scrollbar-width: thin; scrollbar-color: var(--c-thumb) var(--c-surface); }

        #splashScreen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--c-background); z-index: 9999; display: flex; flex-direction: column; align-items: center; justify-content: center; transition: opacity 0.5s, visibility 0.5s; }
        #splashScreen.hidden { opacity: 0; visibility: hidden; }
        #splashScreen p { margin-top: 20px; font-size: 16px; color: var(--c-on-surface-variant); }

        #authContainer { width: 100%; height: 100%; display: flex; align-items: center; justify-content: center; }
        .auth-form-container { width: 100%; max-width: 400px; padding: 40px; background-color: var(--c-surface); border-radius: 12px; border: 1px solid var(--c-border); }
        .auth-form-container h2 { text-align: center; color: var(--c-primary); margin-top: 0; margin-bottom: 24px; }
        .auth-form-container .input-group { margin-bottom: 16px; }
        .auth-form-container .btn { margin-top: 8px; }
        .auth-toggle-link { text-align: center; margin-top: 20px; font-size: 14px; color: var(--c-on-surface-variant); }
        .auth-toggle-link button { background: none; border: none; color: var(--c-primary); font-weight: 600; padding: 0; }
        .auth-toggle-link button:hover { text-decoration: underline; }

        #appContainer { display: flex; flex-direction: column; width: 100%; height: 100%; }

        .sidebar { width: 320px; flex-shrink: 0; background-color: var(--c-surface); border-right: 1px solid var(--c-border); display: flex; flex-direction: column; padding: 24px; transition: margin-left var(--animation-speed), background-color var(--transition-speed), border-color var(--transition-speed); }
        
        .logo-icon { width: 40px; height: 40px; flex-shrink: 0; }
        .sidebar-content { flex-grow: 1; overflow-y: auto; padding: 8px 4px 8px 0; }

        .input-group { margin-bottom: 8px; }

        .select-wrapper { position: relative; width: 100%; }
        .select-wrapper::after { content: '▼'; font-size: 12px; color: var(--c-on-surface-variant); position: absolute; right: 16px; top: 50%; transform: translateY(-50%); pointer-events: none; transition: transform var(--transition-speed) ease, color var(--transition-speed) ease; }
        .select-wrapper:has(.select-field:focus)::after { transform: translateY(-50%) rotate(180deg); color: var(--c-primary); }
        .input-field, .select-field, textarea { width: 100%; padding: 12px 16px; background-color: var(--c-background); border: 1px solid var(--c-border); border-radius: 8px; color: var(--c-on-surface); font-family: var(--font-family-sans); font-size: 14px; outline: none; transition: border-color var(--transition-speed), box-shadow var(--transition-speed); -webkit-appearance: none; -moz-appearance: none; appearance: none; }
        .select-field option { background-color: var(--c-surface); color: var(--c-on-surface); }
        select::-webkit-scrollbar { width: 8px; }
        select::-webkit-scrollbar-track { background-color: var(--c-surface-light); }
        select::-webkit-scrollbar-thumb { background-color: var(--c-thumb); border-radius: 4px; }
        select::-webkit-scrollbar-thumb:hover { background-color: var(--c-primary-variant); }
        .input-field::placeholder, textarea::placeholder { color: var(--c-on-surface-variant); }
        .input-field:focus, .select-field:focus, textarea:focus { border-color: var(--c-primary); box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-primary) 20%, transparent); }
        .input-field.missing, .select-field.missing { border-color: var(--c-error); box-shadow: 0 0 0 3px color-mix(in srgb, var(--c-error) 20%, transparent); animation: shake 0.3s; }
        
        .sidebar-footer { padding-top: 16px; border-top: 1px solid var(--c-border); }
        .btn { padding: 12px 24px; border-radius: 8px; font-weight: 600; border: none; transition: background-color var(--transition-speed), color var(--transition-speed), border-color var(--transition-speed); display: inline-flex; align-items: center; justify-content: center; gap: 8px; }
        .btn-primary { background-color: var(--c-primary); color: #fff; }
        .btn-primary:hover { background-color: var(--c-primary-variant); }
        .btn-secondary { background-color: var(--c-surface-light); color: var(--c-on-surface); border: 1px solid var(--c-border); }
        .btn-secondary:hover { background-color: var(--c-border); }
        .btn-danger { background-color: transparent; color: var(--c-error); border: 1px solid var(--c-error); margin-right: auto; }
        .btn-danger:hover { background-color: var(--c-warning); color: var(--c-warning-text); }
        .btn-full-width { width: 100%; }
        
        .main-content { flex-grow: 1; display: flex; flex-direction: column; overflow: hidden; position: relative; }
        .main-header { display: flex; justify-content: space-between; align-items: center; padding: 20px 40px; border-bottom: 1px solid var(--c-border); background-color: var(--c-surface); flex-shrink: 0; gap: 20px;}
        #headerLeft { display: flex; align-items: center; gap: 40px; flex-grow: 1; }
        .header-title { font-size: 24px; font-weight: 700; color: var(--c-on-surface); display: flex; align-items: center; gap: 12px; }
        .header-title .logo-icon { width: 40px; height: 40px; }
        .header-title .header-page-icon { width: 28px; height: 28px; stroke: var(--c-on-surface); }
        .header-controls { display: flex; align-items: center; gap: 12px; flex-shrink: 0; }
        .search-container { position: relative; width: 100%; max-width: 500px; transition: opacity var(--animation-speed), visibility var(--animation-speed); }
        .search-input { width: 100%; padding: 12px 40px 12px 48px; border-radius: 20px; border: 1px solid var(--c-border); background-color: var(--c-background); color: var(--c-on-surface); font-size: 14px; outline: none; }
        .search-icon { position: absolute; left: 16px; top: 50%; transform: translateY(-50%); width: 20px; height: 20px; stroke: var(--c-on-surface); opacity: 0.5; z-index: 1; }
        #clearSearchBtn { position: absolute; right: 8px; top: 50%; transform: translateY(-50%); width: 60px; height: 30px; background-color: var(--c-surface); border-radius: 9999px; border: 1px solid var(--c-border); cursor: pointer; display: flex; align-items: center; justify-content: center; z-index: 2; transition: background-color var(--transition-speed); }
        #clearSearchBtn svg { stroke: var(--c-primary-variant); transition: stroke var(--transition-speed); }
        #clearSearchBtn:hover { background-color: var(--c-primary-variant); }
        #clearSearchBtn:hover svg { stroke: #fff; }
        .header-btn { cursor: pointer; width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center; justify-content: center; background-color: var(--c-surface); border: 1px solid var(--c-border); position: relative; transition: background-color var(--transition-speed); }
        .header-btn:hover { background-color: var(--c-primary-variant); }
        .header-icon { transition: transform var(--animation-speed) ease, opacity calc(var(--animation-speed) / 2) ease, stroke var(--transition-speed), fill var(--transition-speed); position: absolute; stroke: var(--c-primary-variant); fill: none; }
        .header-btn:hover .header-icon { stroke: #fff; fill: #fff; }
        .header-icon.moon { fill: var(--c-primary-variant); stroke: none; }
        #themeToggle.spin .header-icon { transform: rotate(360deg); }
        body:not(.light-mode) .header-icon.sun { display: none; }
        body.light-mode .header-icon.moon { display: none; }
        
        .page-content { position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; visibility: hidden; transform: translateY(15px); transition: opacity 0.4s ease, transform 0.4s ease, visibility 0s 0.4s; display: flex; }
        .page-content.active { opacity: 1; visibility: visible; transform: translateY(0); transition: opacity 0.4s ease, transform 0.4s ease, visibility 0s 0s; }

        #hotAlertsPage { flex-grow: 1; min-height: 0; }
        .card-container { flex-grow: 1; padding: 40px; overflow-y: auto; }
        .card-container.loading { display: flex; align-items: center; justify-content: center; }
        .card { background-color: var(--c-surface); border-radius: 12px; margin-bottom: 24px; border: 1px solid var(--c-border); overflow: hidden; transition: box-shadow 0.3s, opacity 0.3s, transform 0.3s; width: 100%; }
        .card:hover { box-shadow: 0 8px 30px var(--c-shadow); }
        .card-header { padding: 20px 24px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
        .card-title { font-size: 18px; font-weight: 600; color: var(--c-primary); }
        .card-toggle-icon { width: 24px; height: 24px; transition: transform 0.3s; }
        .card.expanded .card-toggle-icon { transform: rotate(45deg); }
        .card-body { max-height: 0; overflow: hidden; transition: max-height 0.5s ease-in-out, padding 0.5s ease-in-out; padding: 0 24px; }
        .card.expanded .card-body { max-height: 1000px; padding: 0 24px 24px; }
        .template-preview { background-color: var(--c-background); border: 1px solid var(--c-border); border-radius: 8px; padding: 20px; font-size: 15px; line-height: 1.7; white-space: pre-wrap; word-wrap: break-word; }
        .template-preview .filled { font-weight: 600; color: var(--c-on-surface); }
        .template-preview .empty { color: var(--c-error); font-weight: 500; }
        .warning-message { margin-top: 16px; padding: 12px; background-color: var(--c-warning); color: var(--c-warning-text); border-radius: 8px; font-size: 14px; display: none; }
        .copy-btn { margin-top: 16px; }

        #manageTemplatesPage { flex-direction: column; flex-grow: 1; padding: 40px; overflow-y: auto; }
        .settings-wrapper { width: 100%; max-width: 1050px; margin: 0 auto; display: flex; flex-direction: column; flex-grow: 1; }
        .settings-wrapper p { font-size: 15px; color: var(--c-on-surface-variant); margin: 0 0 24px 0; flex-shrink: 0; }
        
        #manageTemplatesContainer { background-color: var(--c-surface); border: 1px solid var(--c-border); border-radius: 12px; padding: 24px; overflow-y: auto; display: flex; flex-direction: column; min-height: 200px; height: auto; transition: min-height var(--animation-speed) ease; }
        
        .template-controls { display: flex; flex-wrap: wrap; gap: 16px; align-items: center; border-bottom: 1px solid var(--c-border); padding-bottom: 24px; margin-bottom: 24px; flex-shrink: 0; }
        .template-controls .select-wrapper { flex-grow: 1; }
        #addNewTemplateBtn { flex-shrink: 0; }
        
        #templateEditor { display: flex; flex-direction: column; flex-grow: 1; }
        .editor-placeholder { display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; color: var(--c-on-surface-variant); flex-grow: 1; min-height: 300px; }
        .editor-placeholder svg { width: 64px; height: 64px; margin-bottom: 16px; opacity: 0.5; }
        
        .setting-item { margin-bottom: 20px; }
        .setting-item.template-body-item { flex-grow: 1; display: flex; flex-direction: column; }
        .setting-item label { display: block; font-size: 14px; font-weight: 500; margin-bottom: 8px; }
        .template-body-textarea { min-height: 200px; height: 30vh; resize: vertical; flex-grow: 1; }
        
        #availableFields { display: flex; flex-wrap: wrap; gap: 8px; margin-bottom: 16px; padding: 10px; border-radius: 8px; background-color: var(--c-background); }
        .field-tag { background-color: var(--c-surface); border: 1px solid var(--c-border); padding: 4px 10px; border-radius: 16px; font-size: 12px; transition: background-color var(--transition-speed), color var(--transition-speed); }
        .field-tag:hover { background-color: var(--c-primary-variant); color: #fff; }

        .required-fields-indicator { margin-top: 16px; font-size: 13px; color: var(--c-on-surface-variant); }
        .required-fields-indicator strong { font-weight: 600; color: var(--c-on-surface); }
        .required-fields-indicator span { background-color: var(--c-background); border: 1px solid var(--c-border); padding: 3px 8px; border-radius: 4px; margin: 0 4px; font-family: monospace; color: var(--c-on-surface); }

        .editor-actions { margin-top: 24px; padding-top: 24px; border-top: 1px solid var(--c-border); display: flex; justify-content: flex-end; gap: 12px; flex-shrink: 0; }
        
        /* Tool Suite Styles */
        #toolSuitePage { flex-direction: column; align-items: center; justify-content: center; flex-grow: 1; padding: 40px; }
        .tool-suite-container { display: grid; grid-template-columns: repeat(auto-fit, minmax(300px, 1fr)); gap: 32px; width: 100%; max-width: 800px; }
        .tool-card { background-color: var(--c-surface); border-radius: 16px; border: 1px solid var(--c-border); padding: 32px; text-align: center; cursor: pointer; transition: transform 0.3s, box-shadow 0.3s; }
        .tool-card:hover { transform: translateY(-8px); box-shadow: 0 12px 40px var(--c-shadow); }
        .tool-card-icon { width: 64px; height: 64px; margin-bottom: 20px; color: var(--c-primary); }
        .tool-card h3 { font-size: 22px; font-weight: 700; margin: 0 0 12px 0; color: var(--c-on-surface); }
        .tool-card p { font-size: 15px; color: var(--c-on-surface-variant); line-height: 1.6; margin: 0; }

        .modal-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background-color: var(--c-modal-backdrop); display: flex; align-items: center; justify-content: center; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s; z-index: 1000; }
        .modal-overlay.visible { opacity: 1; visibility: visible; }
        .modal-content { background: var(--c-surface); padding: 24px; border-radius: 12px; width: 90%; max-width: 450px; text-align: center; transform: scale(0.95); transition: transform 0.3s; }
        .modal-overlay.visible .modal-content { transform: scale(1); }
        .modal-icon { width: 48px; height: 48px; margin-bottom: 16px; }
        .modal-content h3 { margin: 0 0 10px 0; font-size: 18px; }
        .modal-content p { margin: 0 0 24px 0; color: var(--c-on-surface-variant); line-height: 1.6; }
        .modal-actions { display: flex; gap: 12px; justify-content: center; }
        .modal-btn { padding: 10px 24px; border-radius: 8px; border: none; font-weight: 600; }
        .modal-btn.confirm { background-color: var(--c-error); color: #fff; }
        .modal-btn.cancel { background-color: var(--c-border); color: var(--c-on-surface); }
        
        #toastNotification { position: fixed; bottom: -100px; left: 50%; transform: translateX(-50%); background-color: var(--c-primary); color: #fff; padding: 14px 28px; border-radius: 8px; box-shadow: 0 4px 15px var(--c-shadow); font-weight: 600; z-index: 3000; transition: bottom 0.5s ease-in-out; }
        #toastNotification.show { bottom: 30px; }
        #toastNotification.error { background-color: var(--c-error); }

        .loader { width: 48px; height: 48px; border: 5px solid var(--c-border); border-bottom-color: var(--c-primary); border-radius: 50%; display: inline-block; box-sizing: border-box; animation: rotation 1s linear infinite; }
        @keyframes rotation { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }

        .hidden { display: none !important; }
        @keyframes shake { 25% { transform: translateX(6px); } 75% { transform: translateX(-2px); } }
    </style>
</head>
<body>

    <div id="splashScreen">
        <div class="loader"></div>
        <p>Loading Application...</p>
    </div>

    <div id="authContainer" class="hidden">
        <div class="auth-form-container">
            <form id="loginForm">
                <h2>Login</h2>
                <div class="input-group"> <input type="email" id="loginEmail" class="input-field" placeholder="Email" required> </div>
                <div class="input-group"> <input type="password" id="loginPassword" class="input-field" placeholder="Password" required> </div>
                <button type="submit" class="btn btn-primary btn-full-width">Login</button>
                <div class="auth-toggle-link"> Don't have an account? <button type="button" id="showSignup">Sign Up</button> </div>
            </form>

            <form id="signupForm" class="hidden">
                <h2>Sign Up</h2>
                <div class="input-group"> <input type="email" id="signupEmail" class="input-field" placeholder="Email" required> </div>
                <div class="input-group"> <input type="password" id="signupPassword" class="input-field" placeholder="Password" required> </div>
                <button type="submit" class="btn btn-primary btn-full-width">Create Account</button>
                <div class="auth-toggle-link"> Already have an account? <button type="button" id="showLogin">Login</button> </div>
            </form>
        </div>
    </div>

    <div id="appContainer" class="hidden">
        <header class="main-header">
            <div id="headerLeft">
                <div id="headerTitle" class="header-title"></div>
                <div class="search-container hidden" id="searchContainer">
                    <svg class="search-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="11" cy="11" r="8"></circle><line x1="21" y1="21" x2="16.65" y2="16.65"></line></svg>
                    <input type="text" id="cardSearchInput" class="search-input" placeholder="Search templates...">
                    <button id="clearSearchBtn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"><line x1="18" y1="6" x2="6" y2="18"></line><line x1="6" y1="6" x2="18" y2="18"></line></svg></button>
                </div>
            </div>
            <div class="header-controls">
                <button id="backToSuiteBtn" class="header-btn hidden" aria-label="Back to Tool Suite">
                    <svg class="header-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M19 12H5"/><path d="m12 19-7-7 7-7"/></svg>
                </button>
                <button id="themeToggle" class="header-btn" aria-label="Toggle theme">
                    <svg class="header-icon sun" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><circle cx="12" cy="12" r="4"></circle><path d="M12 2v2"></path><path d="M12 20v2"></path><path d="m4.93 4.93 1.41 1.41"></path><path d="m17.66 17.66 1.41 1.41"></path><path d="M2 12h2"></path><path d="M20 12h2"></path><path d="m6.34 17.66-1.41 1.41"></path><path d="m19.07 4.93-1.41 1.41"></path></svg>
                    <svg class="header-icon moon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"></path></svg>
                </button>
                <button id="signOutBtn" class="header-btn" aria-label="Sign Out">
                    <svg class="header-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4"></path><polyline points="16 17 21 12 16 7"></polyline><line x1="21" y1="12" x2="9" y2="12"></line></svg>
                </button>
            </div>
        </header>

        <main class="main-content">
            <div id="toolSuitePage" class="page-content">
                <div class="tool-suite-container">
                    <div class="tool-card" id="navigateToHotAlerts">
                        <svg class="tool-card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>
                        <h3>Hot Alerts</h3>
                        <p>Quickly generate and copy templated messages for customer communication. Fill in dynamic fields and get consistent messaging in seconds.</p>
                    </div>
                    <div class="tool-card" id="navigateToTemplateManager">
                        <svg class="tool-card-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>
                        <h3>Template Manager</h3>
                        <p>Create, edit, and delete your own custom templates. Manage both your personal and the default templates for the Hot Alerts tool.</p>
                    </div>
                </div>
            </div>

            <div id="hotAlertsPage" class="page-content">
                <aside class="sidebar" id="sidebar">
                    <div class="sidebar-content">
                        <div class="input-group"> <div class="select-wrapper"><select id="customerTitle" class="select-field"><option value="">Select Title</option><option value="Mr.">Mr.</option><option value="Mrs.">Mrs.</option><option value="Ms.">Ms.</option></select></div> </div>
                        <div class="input-group"> <input type="text" id="customerName" class="input-field" placeholder="Customer Name"> </div>
                        <div class="input-group"> <input type="text" id="phoneNumber" class="input-field" placeholder="Phone Number"> </div>
                        <div class="input-group"> <input type="text" id="vehicle" class="input-field" placeholder="Vehicle (e.g., Toyota Camry)"> </div>
                        <div class="input-group"> <input type="text" id="vin" class="input-field" placeholder="VIN (17 characters)" maxlength="17"> </div>
                        <div class="input-group"> <input type="text" id="advisor" class="input-field" placeholder="Advisor Name"> </div>
                        <div class="input-group"> <input type="text" id="schedule" class="input-field" placeholder="Schedule (e.g., Tomorrow 10 AM)"> </div>
                        <div class="input-group"> <input type="text" id="accessoryParts" class="input-field" placeholder="Accessory / Parts"> </div>
                        <div class="input-group"> <input type="text" id="tireBrandSize" class="input-field" placeholder="Tire Brand & Size"> </div>
                        <div class="input-group"> <input type="text" id="service" class="input-field" placeholder="Service (e.g., Oil Change)"> </div>
                        <div class="input-group"> <input type="text" id="otherConcern" class="input-field" placeholder="Other Concern"> </div>
                        <div class="input-group"> <input type="text" id="recall" class="input-field" placeholder="RECALL Number or Description"> </div>
                    </div>
                    <div class="sidebar-footer"> <button class="btn btn-secondary btn-full-width" id="clearAllBtn">Clear All Fields</button> </div>
                </aside>
                <div class="card-container" id="cardContainer">
                    <div class="loader hidden" id="loader"></div>
                </div>
            </div>
                
            <div id="manageTemplatesPage" class="page-content">
                 <div class="settings-wrapper">
                    <p>Select a template to preview or edit. You can also create a new custom template.</p>
                    <div id="manageTemplatesContainer">
                        <div class="template-controls">
                           <div class="select-wrapper">
                                <select id="templateSelect" class="select-field"></select>
                            </div>
                            <button id="addNewTemplateBtn" class="btn btn-primary">
                                <svg xmlns="http://www.w3.org/2000/svg" width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                                New
                            </button>
                        </div>
                        <div id="templateEditor">
                             <!-- Editor will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="confirmationModal" class="modal-overlay">
        <div class="modal-content">
            <svg class="modal-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="var(--c-error)" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"></path><path d="M12 9v4"></path><path d="M12 17h.01"></path></svg>
            <h3 id="modalTitle"></h3>
            <p id="modalMessage"></p>
            <div class="modal-actions">
                <button id="modalCancelBtn" class="modal-btn cancel">No, Cancel</button>
                <button id="modalConfirmBtn" class="modal-btn confirm">Yes, Proceed</button>
            </div>
        </div>
    </div>

    <div id="toastNotification"></div>

    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, getDoc, getDocs, setDoc, addDoc, deleteDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        const appId = typeof __app_id !== 'undefined' ? __app_id : 'hot-alerts-app';
        const firebaseConfig = typeof __firebase_config !== 'undefined' ? JSON.parse(__firebase_config) : {
              apiKey: "AIzaSyCKJAYbGCKjxR3YpucDfGXDz9SuyBECb1I",
              authDomain: "hot-alerts.firebaseapp.com",
              projectId: "hot-alerts",
              storageBucket: "hot-alerts.appspot.com",
              messagingSenderId: "560371588593",
              appId: "1:560371588593:web:e0d81dd80eb7ab5ec3f850",
              measurementId: "G-EVX3VEJV0T"
        };
        
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        let userId = null;
        let userTemplatesRef = null;
        let publicTemplatesRef = null;
        let settingsDocRef = null;
        let unsubscribeFromTemplates = null; 
        let justAuthenticated = false;

        document.addEventListener('DOMContentLoaded', () => {
            
            let combinedTemplates = [];
            let publicTmpls = [];
            let userTmpls = [];
            const fieldDisplayNames = { customerTitle: "Select Title", customerName: "Customer Name", phoneNumber: "Phone Number", vehicle: "Vehicle", vin: "VIN", advisor: "Advisor", schedule: "Schedule", accessoryParts: "Accessory / Parts", tireBrandSize: "Tire Brand & Size", service: "Service", otherConcern: "Other Concern", recall: "RECALL" };
            const appState = { currentView: 'toolSuite', editorMode: 'none', selectedTemplateId: null, hiddenTemplates: [] };
            const body = document.body;
            
            const splashScreen = document.getElementById('splashScreen');
            const authContainer = document.getElementById('authContainer');
            const appContainer = document.getElementById('appContainer');
            const allPageContents = document.querySelectorAll('.page-content');
            
            const loginForm = document.getElementById('loginForm');
            const signupForm = document.getElementById('signupForm');
            const showSignupBtn = document.getElementById('showSignup');
            const showLoginBtn = document.getElementById('showLogin');
            const signOutBtn = document.getElementById('signOutBtn');

            const headerTitle = document.getElementById('headerTitle');
            const searchContainer = document.getElementById('searchContainer');
            const backToSuiteBtn = document.getElementById('backToSuiteBtn');
            const cardSearchInput = document.getElementById('cardSearchInput');
            const clearSearchBtn = document.getElementById('clearSearchBtn');

            const navigateToHotAlerts = document.getElementById('navigateToHotAlerts');
            const navigateToTemplateManager = document.getElementById('navigateToTemplateManager');

            const cardContainer = document.getElementById('cardContainer');
            const loader = document.getElementById('loader');
            const allInputFields = document.querySelectorAll('.sidebar-content .input-field, .sidebar-content .select-field');

            const manageTemplatesContainer = document.getElementById('manageTemplatesContainer');
            const templateSelect = document.getElementById('templateSelect');
            const addNewTemplateBtn = document.getElementById('addNewTemplateBtn');
            const templateEditor = document.getElementById('templateEditor');

            const modal = document.getElementById('confirmationModal');
            const modalTitle = document.getElementById('modalTitle');
            const modalMessage = document.getElementById('modalMessage');
            const modalConfirmBtn = document.getElementById('modalConfirmBtn');
            const modalCancelBtn = document.getElementById('modalCancelBtn');
            const toastNotification = document.getElementById('toastNotification');
            let confirmCallback = null;

            function renderCurrentView(view) {
                appState.currentView = view;

                allPageContents.forEach(page => page.classList.remove('active'));
                document.getElementById(`${view}Page`).classList.add('active');
                
                searchContainer.classList.add('hidden');
                backToSuiteBtn.classList.add('hidden');

                const toolSuiteSVG = `<svg class="header-page-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="2" y="7" width="20" height="14" rx="2" ry="2"></rect><path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"></path></svg>`;
                const hotAlertsLogoSVG = `<svg class="header-page-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M18 8A6 6 0 0 0 6 8c0 7-3 9-3 9h18s-3-2-3-9"/><path d="M13.73 21a2 2 0 0 1-3.46 0"/></svg>`;
                const manageTemplatesSVG = `<svg class="header-page-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M11 4H4a2 2 0 0 0-2 2v14a2 2 0 0 0 2 2h14a2 2 0 0 0 2-2v-7"></path><path d="M18.5 2.5a2.121 2.121 0 0 1 3 3L12 15l-4 1 1-4 9.5-9.5z"></path></svg>`;

                if (view === 'toolSuite') {
                    headerTitle.innerHTML = `${toolSuiteSVG} <span>Tool Suite</span>`;
                } else if (view === 'hotAlerts') {
                    cardContainer.innerHTML = '';
                    cardContainer.classList.add('loading');
                    loader.classList.remove('hidden');
                    cardContainer.appendChild(loader);

                    setTimeout(() => {
                        searchContainer.classList.remove('hidden');
                        backToSuiteBtn.classList.remove('hidden');
                        headerTitle.innerHTML = `${hotAlertsLogoSVG} <span>Hot Alerts</span>`;
                        cardContainer.classList.remove('loading');
                        loader.classList.add('hidden');
                        renderAllCards();
                    }, 200);

                } else if (view === 'manageTemplates') {
                    backToSuiteBtn.classList.remove('hidden');
                    headerTitle.innerHTML = `${manageTemplatesSVG} <span>Template Manager</span>`;
                    renderManageTemplatesView();
                }
            }


            // --- Firestore Functions ---
            async function addTemplate(templateData) {
                if (!userTemplatesRef) return;
                try { await addDoc(userTemplatesRef, templateData); } catch (e) { console.error("Error adding document: ", e); }
            }

            async function updateTemplate(id, templateData) {
                if (!userTemplatesRef) return;
                try {
                    const templateDocRef = doc(userTemplatesRef, id);
                    await setDoc(templateDocRef, templateData);
                } catch (e) { console.error("Error updating document: ", e); }
            }

            async function deleteTemplate(id) {
                if (!userTemplatesRef) return;
                try {
                    const templateDocRef = doc(userTemplatesRef, id);
                    await deleteDoc(templateDocRef);
                } catch (e) { console.error("Error deleting document: ", e); }
            }
            
            async function saveUserPreference(key, value) {
                if (!settingsDocRef) return;
                try { await setDoc(settingsDocRef, { [key]: value }, { merge: true }); } catch (e) { console.error(`Error saving preference '${key}':`, e); }
            }
            
            async function initializeUserSettings() {
                if (!settingsDocRef) return;
                const docSnap = await getDoc(settingsDocRef);
                if (!docSnap.exists()) {
                    await setDoc(settingsDocRef, { theme: 'dark', hiddenTemplates: [] });
                    body.classList.remove('light-mode');
                    appState.hiddenTemplates = [];
                } else {
                    const prefs = docSnap.data();
                    if (prefs.theme === 'light') body.classList.add('light-mode'); else body.classList.remove('light-mode');
                    appState.hiddenTemplates = prefs.hiddenTemplates || [];
                }
            }

            function mergeAndRenderTemplates(userSnapshot) {
                userTmpls = userSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isPublic: false, isCustom: true }));
                
                const visiblePublicTmpls = publicTmpls.filter(t => !appState.hiddenTemplates.includes(t.id));
                combinedTemplates = [...visiblePublicTmpls, ...userTmpls].sort((a, b) => a.title.localeCompare(b.title));
                
                if (appState.currentView === 'hotAlerts') {
                    renderAllCards();
                }
                
                if(appState.currentView === 'manageTemplates') {
                    renderManageTemplatesView();
                }
            }

            function showToast(message, isError = false) {
                toastNotification.textContent = message;
                toastNotification.classList.toggle('error', isError);
                toastNotification.classList.add('show');
                setTimeout(() => { toastNotification.classList.remove('show'); }, 3000);
            }

            function renderAllCards() {
                cardContainer.innerHTML = '';
                if (combinedTemplates.length === 0) {
                    cardContainer.innerHTML = `<div class="editor-placeholder"><p>No templates to display.</p><p>You can unhide default templates or create your own in the Template Manager.</p></div>`;
                    return;
                }
                combinedTemplates.forEach(addCardToDOM);
            }

            function addCardToDOM(templateData) {
                const card = document.createElement('div');
                card.className = 'card';
                card.dataset.id = templateData.id; 
                card.dataset.title = templateData.title.toLowerCase();
                const required = (templateData.template.match(/\[\[(.*?)\]\]/g) || []).map(v => v.slice(2, -2));
                card.dataset.required = [...new Set(required)].join(',');

                card.innerHTML = `
                    <div class="card-header">
                        <span class="card-title">${templateData.title} ${templateData.isCustom ? ' (Custom)' : ''}</span>
                        <svg class="card-toggle-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="12" y1="5" x2="12" y2="19"></line><line x1="5" y1="12" x2="19" y2="12"></line></svg>
                    </div>
                    <div class="card-body">
                        <div class="template-preview"></div>
                        <div class="warning-message"></div>
                        <button class="btn btn-primary copy-btn">Copy Template</button>
                    </div>
                `;
                cardContainer.appendChild(card);
                card.querySelector('.card-header').addEventListener('click', () => toggleCard(card));
                card.querySelector('.copy-btn').addEventListener('click', () => copyTemplate(card));
            }
            
            async function handleHideTemplate(templateId) {
                if (!appState.hiddenTemplates.includes(templateId)) {
                    appState.hiddenTemplates.push(templateId);
                    await saveUserPreference('hiddenTemplates', appState.hiddenTemplates);
                    showToast("Template hidden.");
                    mergeAndRenderTemplates({ docs: userTmpls.map(t => ({ id: t.id, data: () => t })) });
                    handleCancelAction();
                }
            }

            async function handleUnhideTemplate(templateId) {
                appState.hiddenTemplates = appState.hiddenTemplates.filter(id => id !== templateId);
                await saveUserPreference('hiddenTemplates', appState.hiddenTemplates);
                showToast("Template unhidden.");
                mergeAndRenderTemplates({ docs: userTmpls.map(t => ({ id: t.id, data: () => t })) });
                handleCancelAction();
            }

            function renderManageTemplatesView() {
                populateTemplateSelect();
                renderEditorForSelection();
            }

            function populateTemplateSelect() {
                const selectedValue = templateSelect.value;
                templateSelect.innerHTML = '<option value="">Select a template...</option>';
                
                const customOptGroup = document.createElement('optgroup');
                customOptGroup.label = 'Custom Templates';
                userTmpls.sort((a,b) => a.title.localeCompare(b.title)).forEach(template => {
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = template.title;
                    customOptGroup.appendChild(option);
                });
                templateSelect.appendChild(customOptGroup);

                const defaultOptGroup = document.createElement('optgroup');
                defaultOptGroup.label = 'Default Templates';
                publicTmpls.sort((a,b) => a.title.localeCompare(b.title)).forEach(template => {
                    const isHidden = appState.hiddenTemplates.includes(template.id);
                    const option = document.createElement('option');
                    option.value = template.id;
                    option.textContent = `${template.title} ${isHidden ? '(Hidden)' : ''}`;
                    defaultOptGroup.appendChild(option);
                });
                templateSelect.appendChild(defaultOptGroup);

                templateSelect.value = selectedValue;
            }

            function renderEditorForSelection() {
                const selectedId = templateSelect.value;
                appState.selectedTemplateId = selectedId;

                if (!selectedId) {
                    manageTemplatesContainer.style.minHeight = '200px';
                    templateEditor.innerHTML = `<div class="editor-placeholder">
                        <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="1.5" stroke-linecap="round" stroke-linejoin="round"><path d="M20 14.66V20a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V6a2 2 0 0 1 2-2h5.34"></path><polygon points="18 2 22 6 12 16 8 16 8 12 18 2"></polygon></svg>
                        <p>Select a template to preview or edit, or create a new one.</p>
                    </div>`;
                    return;
                }

                const templateData = [...publicTmpls, ...userTmpls].find(t => t.id === selectedId);
                if (!templateData) return;

                if (templateData.isCustom) {
                    appState.editorMode = 'edit';
                    renderFullEditor(templateData);
                } else {
                    appState.editorMode = 'preview';
                    renderPreview(templateData);
                }
            }

            function renderFullEditor(templateData) {
                manageTemplatesContainer.style.minHeight = '600px';
                templateEditor.innerHTML = `
                    <div class="setting-item">
                        <label for="templateTitle">Template Title</label>
                        <input type="text" id="templateTitle" class="input-field" placeholder="e.g., Follow-up Call" value="${templateData.title}">
                    </div>
                    <div class="setting-item">
                        <label>Available Fields (Click to insert)</label>
                        <div id="availableFields"></div>
                    </div>
                    <div class="setting-item template-body-item">
                        <label for="templateBody">Template Body</label>
                        <textarea id="templateBody" class="template-body-textarea" placeholder="Compose template... e.g., Good day, This is [[advisor]]...">${templateData.template}</textarea>
                    </div>
                    <div id="requiredFieldsIndicator" class="required-fields-indicator"></div>
                    <div class="editor-actions">
                        <button id="deleteTemplateBtn" class="btn btn-danger">Delete</button>
                        <button id="cancelActionBtn" class="btn btn-secondary">Cancel</button>
                        <button id="saveActionBtn" class="btn btn-primary">${appState.editorMode === 'add' ? 'Save as New Custom Template' : 'Save Changes'}</button>
                    </div>
                `;

                const bodyTextarea = document.getElementById('templateBody');
                const availableFieldsContainer = document.getElementById('availableFields');
                const requiredIndicator = document.getElementById('requiredFieldsIndicator');

                populateAvailableFields(availableFieldsContainer, bodyTextarea);
                updateRequiredFieldsIndicator(bodyTextarea, requiredIndicator);

                bodyTextarea.addEventListener('input', () => updateRequiredFieldsIndicator(bodyTextarea, requiredIndicator));
                document.getElementById('cancelActionBtn').addEventListener('click', handleCancelAction);
                document.getElementById('saveActionBtn').addEventListener('click', handleSaveAction);
                document.getElementById('deleteTemplateBtn').addEventListener('click', () => handleDeleteTemplate(templateData.id));
            }

            function renderPreview(templateData) {
                manageTemplatesContainer.style.minHeight = '350px';
                const isHidden = appState.hiddenTemplates.includes(templateData.id);
                templateEditor.innerHTML = `
                    <div class="setting-item">
                        <label>Template Preview</label>
                        <div class="template-preview">${templateData.template.replace(/\[\[(.*?)\]\]/g, '<span class="empty">[$1]</span>')}</div>
                    </div>
                    <div class="editor-actions">
                         <button id="cancelActionBtn" class="btn btn-secondary">Cancel</button>
                         <button id="visibilityToggleBtn" class="btn ${isHidden ? 'btn-primary' : 'btn-secondary'}">${isHidden ? 'Unhide' : 'Hide'}</button>
                    </div>
                `;
                document.getElementById('cancelActionBtn').addEventListener('click', handleCancelAction);
                document.getElementById('visibilityToggleBtn').addEventListener('click', () => {
                    if (isHidden) handleUnhideTemplate(templateData.id);
                    else handleHideTemplate(templateData.id);
                });
            }

            function populateAvailableFields(container, textarea) {
                container.innerHTML = '';
                for (const [id, name] of Object.entries(fieldDisplayNames)) {
                    const tag = document.createElement('span');
                    tag.className = 'field-tag';
                    tag.textContent = name;
                    tag.addEventListener('click', () => {
                        const { selectionStart, selectionEnd } = textarea;
                        const textToInsert = `[[${id}]]`;
                        textarea.value = textarea.value.substring(0, selectionStart) + textToInsert + textarea.value.substring(selectionEnd);
                        textarea.focus();
                        textarea.selectionStart = textarea.selectionEnd = selectionStart + textToInsert.length;
                        textarea.dispatchEvent(new Event('input', { bubbles: true }));
                    });
                    container.appendChild(tag);
                }
            }

            function updateRequiredFieldsIndicator(textarea, indicatorElement) {
                const foundFields = textarea.value.match(/\[\[(.*?)\]\]/g) || [];
                const uniqueFieldIds = [...new Set(foundFields.map(f => f.slice(2, -2)))];
                
                if (uniqueFieldIds.length === 0) {
                    indicatorElement.innerHTML = '<strong>Required Fields Detected:</strong> None';
                    return;
                }
                const fieldSpans = uniqueFieldIds.map(id => `<span>${fieldDisplayNames[id] || id}</span>`).join('');
                indicatorElement.innerHTML = `<strong>Required Fields Detected:</strong> ${fieldSpans}`;
            }

            function handleAddNewClick() {
                appState.selectedTemplateId = 'new-template';
                appState.editorMode = 'add';
                templateSelect.value = '';
                renderFullEditor({title: '', template: ''});
            }

            function handleCancelAction() {
                appState.selectedTemplateId = null;
                appState.editorMode = 'none';
                templateSelect.value = '';
                renderEditorForSelection();
            }

            async function handleSaveAction() {
                const titleInput = document.getElementById('templateTitle');
                const bodyInput = document.getElementById('templateBody');
                const title = titleInput.value.trim();
                const template = bodyInput.value.trim();
                const currentTemplate = [...publicTmpls, ...userTmpls].find(t => t.id === appState.selectedTemplateId);

                if (!title || !template) {
                    if (!title) titleInput.classList.add('missing');
                    if (!template) bodyInput.classList.add('missing');
                    showToast("Title and body cannot be empty.", true);
                    return;
                }
                titleInput.classList.remove('missing');
                bodyInput.classList.remove('missing');

                const templateData = { title, template };

                const isCreating = appState.editorMode === 'add';
                const isUpdating = appState.editorMode === 'edit' && currentTemplate && currentTemplate.isCustom;

                if (isCreating) {
                    const duplicate = [...publicTmpls, ...userTmpls].find(t => t.title.toLowerCase() === title.toLowerCase());
                    if (duplicate) { showToast("A template with this title already exists.", true); titleInput.classList.add('missing'); return; }
                    await addTemplate(templateData);
                    showToast("Custom template saved successfully!");
                    handleCancelAction();
                } else if (isUpdating) {
                     const duplicate = [...publicTmpls, ...userTmpls].find(t => t.id !== currentTemplate.id && t.title.toLowerCase() === title.toLowerCase());
                    if (duplicate) { showToast("Another template with this title already exists.", true); titleInput.classList.add('missing'); return; }
                    await updateTemplate(currentTemplate.id, templateData);
                    showToast("Template updated successfully!");
                    handleCancelAction();
                }
            }
            
            async function handleDeleteTemplate(templateId) {
                if (!templateId) return;
                showConfirmationModal(
                    'Delete Template', 'Are you sure you want to permanently delete this custom template?',
                    async () => {
                        await deleteTemplate(templateId);
                        hideConfirmationModal();
                        showToast("Template deleted.");
                        handleCancelAction();
                    }
                );
            }

            function showConfirmationModal(title, message, onConfirm) {
                modalTitle.textContent = title;
                modalMessage.textContent = message;
                confirmCallback = onConfirm;
                modal.classList.add('visible');
            }
            
            function hideConfirmationModal() {
                modal.classList.remove('visible');
                confirmCallback = null;
            }

            function getFormattedValue(fieldId, value) { value = value.trim(); if (!value) return value; switch (fieldId) { case 'customerName': case 'advisor': case 'accessoryParts': case 'service': return value.toLowerCase().split(' ').map(word => word.charAt(0).toUpperCase() + word.slice(1)).join(' '); case 'vehicle': case 'vin': case 'schedule': case 'tireBrandSize': return value.toUpperCase(); case 'otherConcern': return value.charAt(0).toUpperCase() + value.slice(1).toLowerCase(); default: return value; } }
            function toggleCard(card) { document.querySelectorAll('.card.expanded').forEach(openCard => { if (openCard !== card) openCard.classList.remove('expanded'); }); document.querySelectorAll('.missing').forEach(el => el.classList.remove('missing')); card.classList.toggle('expanded'); if (card.classList.contains('expanded')) updateCardContent(card); }
            function updateAllCards() { document.querySelectorAll('.card.expanded').forEach(updateCardContent); }
            function copyTemplate(card) { const preview = card.querySelector('.template-preview'); const copyBtn = card.querySelector('.copy-btn'); const tempTextArea = document.createElement('textarea'); tempTextArea.value = preview.innerText; document.body.appendChild(tempTextArea); tempTextArea.select(); document.execCommand('copy'); document.body.removeChild(tempTextArea); copyBtn.textContent = 'Copied!'; setTimeout(() => { copyBtn.textContent = 'Copy Template'; }, 1500); }
            function clearAllFields() { const clearButton = document.getElementById('clearAllBtn'); allInputFields.forEach(input => { input.value = ''; input.classList.remove('missing'); }); document.querySelectorAll('.card-body .select-field').forEach(select => { select.value = ''; select.classList.remove('missing'); }); updateAllCards(); clearButton.textContent = 'Cleared!'; setTimeout(() => { clearButton.textContent = 'Clear All Fields'; }, 1500); }
            function updateCardContent(card) { const templateId = card.dataset.id; const templateData = combinedTemplates.find(t => t.id === templateId); if (!templateData) return; const requiredFields = card.dataset.required.split(','); const preview = card.querySelector('.template-preview'); const warning = card.querySelector('.warning-message'); const copyBtn = card.querySelector('.copy-btn'); let allRequiredFilled = true; const missingFieldNames = []; requiredFields.forEach(fieldId => { if (!fieldId) return; const element = document.getElementById(fieldId); if (element && !element.value.trim()) { allRequiredFilled = false; element.classList.add('missing'); missingFieldNames.push(element.placeholder || fieldDisplayNames[fieldId]); } else if (element) { element.classList.remove('missing'); } }); const renderedTemplate = templateData.template.replace(/\[\[(.*?)\]\]/g, (_, fieldId) => { const element = document.getElementById(fieldId); const value = element ? element.value : ''; const formattedValue = getFormattedValue(fieldId, value); return formattedValue ? `<span class="filled">${formattedValue}</span>` : `<span class="empty">[${fieldDisplayNames[fieldId] || fieldId}]</span>`; }); preview.innerHTML = renderedTemplate; warning.style.display = allRequiredFilled ? 'none' : 'block'; copyBtn.disabled = !allRequiredFilled; if (!allRequiredFilled) warning.textContent = `⚠️ Required: ${[...new Set(missingFieldNames)].join(', ')}`; }
            
            let isInitialized = false;
            function initializeApp() {
                if (isInitialized) return;
                isInitialized = true;
                
                // --- Event Listeners ---
                navigateToHotAlerts.addEventListener('click', () => renderCurrentView('hotAlerts'));
                navigateToTemplateManager.addEventListener('click', () => renderCurrentView('manageTemplates'));
                backToSuiteBtn.addEventListener('click', () => renderCurrentView('toolSuite'));

                document.getElementById('phoneNumber').addEventListener('input', (e) => { const x = e.target.value.replace(/\D/g, '').match(/(\d{0,3})(\d{0,3})(\d{0,4})/); e.target.value = !x[2] ? x[1] : `(${x[1]}) ${x[2]}` + (x[3] ? `-${x[3]}` : ''); });
                document.getElementById('vin').addEventListener('input', (e) => { e.target.value = e.target.value.replace(/[^a-zA-Z0-9]/g, '').toUpperCase(); });
                const themeToggle = document.getElementById('themeToggle');
                themeToggle.addEventListener('click', () => { 
                    const isLight = body.classList.toggle('light-mode'); 
                    saveUserPreference('theme', isLight ? 'light' : 'dark');
                    themeToggle.classList.add('spin'); 
                    setTimeout(() => themeToggle.classList.remove('spin'), 500); 
                });
                
                cardSearchInput.addEventListener('keyup', (e) => { 
                    const searchTerm = e.target.value.toLowerCase(); 
                    document.querySelectorAll('.card').forEach(card => { 
                        card.style.display = card.dataset.title.includes(searchTerm) ? 'block' : 'none'; 
                    });
                });
                clearSearchBtn.addEventListener('click', () => {
                    cardSearchInput.value = '';
                    cardSearchInput.dispatchEvent(new Event('keyup'));
                });

                templateSelect.addEventListener('change', renderEditorForSelection);
                document.getElementById('clearAllBtn').addEventListener('click', clearAllFields);
                addNewTemplateBtn.addEventListener('click', handleAddNewClick);
                
                modalConfirmBtn.addEventListener('click', () => { if (confirmCallback) confirmCallback(); });
                modalCancelBtn.addEventListener('click', hideConfirmationModal);
                allInputFields.forEach(field => field.addEventListener('input', updateAllCards));
            }

            // --- Authentication Flow ---
            loginForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('loginEmail').value;
                const password = document.getElementById('loginPassword').value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    justAuthenticated = true;
                } catch (error) { showToast(error.message, true); }
            });

            signupForm.addEventListener('submit', async (e) => {
                e.preventDefault();
                const email = document.getElementById('signupEmail').value;
                const password = document.getElementById('signupPassword').value;
                try {
                    await createUserWithEmailAndPassword(auth, email, password);
                    justAuthenticated = true;
                } catch (error) { showToast(error.message, true); }
            });

            signOutBtn.addEventListener('click', () => {
                 showConfirmationModal( 'Sign Out', 'Are you sure you want to sign out?',
                    async () => {
                        await signOut(auth);
                        hideConfirmationModal();
                        showToast("You have been signed out.");
                    }
                );
            });

            showSignupBtn.addEventListener('click', () => {
                loginForm.classList.add('hidden');
                signupForm.classList.remove('hidden');
            });

            showLoginBtn.addEventListener('click', () => {
                signupForm.classList.add('hidden');
                loginForm.classList.remove('hidden');
            });
            
            onAuthStateChanged(auth, async (user) => {
                if (user) {
                    userId = user.uid;
                    console.log("User authenticated with UID:", userId);
                    
                    const isFreshLogin = justAuthenticated;
                    if (isFreshLogin) {
                        showToast("Login successful!");
                        justAuthenticated = false;
                    }
                    
                    splashScreen.classList.remove('hidden');

                    setTimeout(async () => {
                        authContainer.classList.add('hidden');
                        appContainer.classList.remove('hidden');
                        
                        initializeApp();
                        renderCurrentView('toolSuite');

                        try {
                            const userPath = `artifacts/${appId}/users/${userId}`;
                            const publicPath = `artifacts/${appId}/public/data`;
                            
                            userTemplatesRef = collection(db, `${userPath}/templates`);
                            publicTemplatesRef = collection(db, `${publicPath}/default_templates`);
                            settingsDocRef = doc(db, `${userPath}/settings`, 'preferences');
                            
                            await initializeUserSettings(); 
                            
                            const publicSnapshot = await getDocs(publicTemplatesRef);
                            publicTmpls = publicSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data(), isPublic: true, isCustom: false }));

                            if (unsubscribeFromTemplates) unsubscribeFromTemplates();

                            unsubscribeFromTemplates = onSnapshot(userTemplatesRef, (userSnapshot) => {
                                mergeAndRenderTemplates(userSnapshot);
                            }, (error) => {
                                console.error("Error with template snapshot listener:", error);
                                showToast("Error listening for template updates.", true);
                            });
                            
                        } catch (error) {
                            console.error("Error during data setup:", error);
                            showToast("Error loading user data.", true);
                        } finally {
                            splashScreen.classList.add('hidden');
                        }
                    }, isFreshLogin ? 1000 : 100);

                } else {
                    console.log("No user signed in.");
                    userId = null;
                    if (unsubscribeFromTemplates) unsubscribeFromTemplates();
                    
                    setTimeout(() => {
                        splashScreen.classList.add('hidden');
                        appContainer.classList.add('hidden');
                        authContainer.classList.remove('hidden');
                    }, 500);
                }
            });

        });
    </script>
</body>
</html>
